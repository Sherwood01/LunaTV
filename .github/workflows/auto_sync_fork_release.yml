name: Auto Sync Fork with Releases

on:
 # schedule:
  #  - cron: '0 2 * * *'  # æ¯å¤© UTC 2:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  # ğŸ”§ åœ¨è¿™é‡Œé…ç½®ä½ çš„ä¸Šæ¸¸ä»“åº“ä¿¡æ¯
  UPSTREAM_REPO: "MoonTechLab/LunaTV"  # ä¾‹å¦‚: "MoonTechLab/Selene"
  UPSTREAM_URL: "https://github.com/MoonTechLab/LunaTV.git"

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add Upstream
        run: |
          git remote add upstream ${{ env.UPSTREAM_URL }} || true
          git fetch upstream --tags

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Sync Safe Tags and Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å®šä¹‰å‡½æ•°ï¼šä¸‹è½½æºä»£ç åŒ…
          download_source_code_assets() {
            local TAG=$1
            echo "ğŸ“¥ ä¸‹è½½æºä»£ç åŒ…..."
            
            # GitHub è‡ªåŠ¨ç”Ÿæˆçš„æºä»£ç åŒ… URL
            local SOURCE_CODE_URLS=(
              "https://github.com/${{ env.UPSTREAM_REPO }}/archive/refs/tags/$TAG.zip"
              "https://github.com/${{ env.UPSTREAM_REPO }}/archive/refs/tags/$TAG.tar.gz"
            )
            
            for SOURCE_URL in "${SOURCE_CODE_URLS[@]}"; do
              FILENAME="temp_assets/$TAG/$(basename "$SOURCE_URL")"
              echo "â¬‡ï¸ ä¸‹è½½æºä»£ç åŒ…: $(basename "$SOURCE_URL")"
              if curl -L -f -o "$FILENAME" "$SOURCE_URL"; then
                echo "âœ… æºä»£ç åŒ…ä¸‹è½½æˆåŠŸ"
              else
                echo "âŒ æºä»£ç åŒ…ä¸‹è½½å¤±è´¥"
              fi
            done
          }
          
          # å®šä¹‰å‡½æ•°ï¼šåˆ›å»º Release
          create_release_with_assets() {
            local TAG=$1
            local RELEASE_BODY=$2
            
            if [ "$(ls -A temp_assets/$TAG/* 2>/dev/null)" ]; then
              echo "ğŸš€ åˆ›å»º Release: $TAG"
              
              RELEASE_DATA=$(cat << EOF
{
  "tag_name": "$TAG",
  "name": "$TAG (Synced from ${{ env.UPSTREAM_REPO }})",
  "body": "$RELEASE_BODY",
  "draft": false,
  "prerelease": false
}
EOF
              )
              
              CREATE_RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
                -d "$RELEASE_DATA")
              
              NEW_RELEASE_ID=$(echo "$CREATE_RESPONSE" | jq -r '.id // empty')
              
              if [ -n "$NEW_RELEASE_ID" ]; then
                echo "âœ… Release åˆ›å»ºæˆåŠŸï¼ŒID: $NEW_RELEASE_ID"
                
                # ä¸Šä¼  Assets
                for ASSET_FILE in temp_assets/$TAG/*; do
                  if [ -f "$ASSET_FILE" ]; then
                    ASSET_NAME=$(basename "$ASSET_FILE")
                    echo "â¬†ï¸ ä¸Šä¼ : $ASSET_NAME"
                    
                    UPLOAD_RESPONSE=$(curl -s -X POST \
                      -H "Authorization: token $GITHUB_TOKEN" \
                      -H "Accept: application/vnd.github.v3+json" \
                      -H "Content-Type: application/octet-stream" \
                      "https://uploads.github.com/repos/$GITHUB_REPOSITORY/releases/$NEW_RELEASE_ID/assets?name=$ASSET_NAME" \
                      --data-binary @"$ASSET_FILE")
                    
                    if echo "$UPLOAD_RESPONSE" | jq -r '.id // empty' | grep -q .; then
                      echo "âœ… ä¸Šä¼ æˆåŠŸ: $ASSET_NAME"
                    else
                      echo "âŒ ä¸Šä¼ å¤±è´¥: $ASSET_NAME"
                    fi
                  fi
                done
                return 0
              else
                echo "âŒ Release åˆ›å»ºå¤±è´¥"
                echo "å“åº”: $CREATE_RESPONSE"
                return 1
              fi
            else
              echo "âŒ æ²¡æœ‰å¯ç”¨çš„æ–‡ä»¶"
              return 1
            fi
          }

          echo "=== å¼€å§‹åŒæ­¥ ${{ env.UPSTREAM_REPO }} ==="
          
          # è·å–æ‰€æœ‰ä¸Šæ¸¸ Tags
          git fetch upstream --tags
          UPSTREAM_TAGS=$(git ls-remote --tags upstream | grep -v '\^{}' | awk -F/ '{print $3}' | sort -V)
          
          echo "å‘ç°ä¸Šæ¸¸ Tags:"
          echo "$UPSTREAM_TAGS"
          echo ""

          # å¤„ç†æ¯ä¸ª Tag
          for TAG in $UPSTREAM_TAGS; do
            echo "ğŸ” å¤„ç† Tag: $TAG"
            
            # æ£€æŸ¥è¿™ä¸ª Tag æ˜¯å¦åŒ…å« workflow æ–‡ä»¶ï¼ˆå®‰å…¨è¿‡æ»¤ï¼‰
            if git ls-tree -r upstream/$TAG --name-only 2>/dev/null | grep -q "^\.github/workflows/"; then
              echo "âŒ è·³è¿‡ $TAG (åŒ…å« workflow æ–‡ä»¶)"
              echo ""
              continue
            fi
            
            echo "âœ… $TAG æ˜¯å®‰å…¨çš„ Tag"
            
            # æ¨é€ Tag åˆ°æœ¬åœ°ä»“åº“
            echo "ğŸ“¤ æ¨é€ Tag: $TAG"
            git push origin "refs/tags/$TAG" 2>/dev/null || echo "â„¹ï¸ Tag å¯èƒ½å·²å­˜åœ¨"
            
            # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰ Release
            LOCAL_RELEASE_URL="https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/$TAG"
            LOCAL_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$LOCAL_RELEASE_URL")
            LOCAL_RELEASE_ID=$(echo "$LOCAL_RESPONSE" | jq -r '.id // empty')
            
            if [ -n "$LOCAL_RELEASE_ID" ]; then
              echo "â„¹ï¸ æœ¬åœ°å·²æœ‰ Releaseï¼Œè·³è¿‡: $TAG"
              echo ""
              continue
            fi
            
            # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰ Release
            UPSTREAM_RELEASE_URL="https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/tags/$TAG"
            UPSTREAM_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$UPSTREAM_RELEASE_URL")
            UPSTREAM_RELEASE_ID=$(echo "$UPSTREAM_RESPONSE" | jq -r '.id // empty')
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p "temp_assets/$TAG"
            
            if [ -z "$UPSTREAM_RELEASE_ID" ]; then
              echo "â„¹ï¸ ä¸Šæ¸¸æ²¡æœ‰ $TAG çš„ Releaseï¼Œåˆ›å»ºåŒ…å«æºä»£ç åŒ…çš„ Release"
              
              # ä¸‹è½½æºä»£ç åŒ…
              download_source_code_assets "$TAG"
              
              # åˆ›å»º Release
              create_release_with_assets "$TAG" "Automatically synced from ${{ env.UPSTREAM_REPO }}\n\nåŒ…å«æºä»£ç åŒ…ã€‚"
              
            else
              # æ£€æŸ¥ä¸Šæ¸¸ Release æ˜¯å¦æœ‰ Assets
              ASSETS_COUNT=$(echo "$UPSTREAM_RESPONSE" | jq -r '.assets | length')
              
              if [ "$ASSETS_COUNT" -eq 0 ]; then
                echo "â„¹ï¸ ä¸Šæ¸¸ Release æ²¡æœ‰ Assetsï¼Œåˆ›å»ºåŒ…å«æºä»£ç åŒ…çš„ Release"
                
                # ä¸‹è½½æºä»£ç åŒ…
                download_source_code_assets "$TAG"
                
                # åˆ›å»º Release
                create_release_with_assets "$TAG" "Automatically synced from ${{ env.UPSTREAM_REPO }}\n\nåŒ…å«æºä»£ç åŒ…ã€‚"
                
              else
                echo "âœ… å‘ç°ä¸Šæ¸¸ Release æœ‰ $ASSETS_COUNT ä¸ª Assets"
                
                # ä¸‹è½½ä¸Šæ¸¸ Assets
                echo "ğŸ“¥ ä¸‹è½½ä¸Šæ¸¸ Assets..."
                ASSET_URLS=$(echo "$UPSTREAM_RESPONSE" | jq -r '.assets[].browser_download_url')
                
                for ASSET_URL in $ASSET_URLS; do
                  if [ -n "$ASSET_URL" ]; then
                    FILENAME="temp_assets/$TAG/$(basename "$ASSET_URL")"
                    echo "â¬‡ï¸ ä¸‹è½½: $(basename "$ASSET_URL")"
                    curl -L -o "$FILENAME" "$ASSET_URL" && echo "âœ… ä¸‹è½½æˆåŠŸ" || echo "âŒ ä¸‹è½½å¤±è´¥"
                  fi
                done
                
                # åŒæ—¶ä¸‹è½½æºä»£ç åŒ…
                download_source_code_assets "$TAG"
                
                # åˆ›å»º Release
                create_release_with_assets "$TAG" "Automatically synced from ${{ env.UPSTREAM_REPO }}\n\nåŒ…å«ä¸Šæ¸¸å‘å¸ƒçš„æ–‡ä»¶å’Œæºä»£ç åŒ…ã€‚"
              fi
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf "temp_assets/$TAG"
            echo ""
          done

      - name: Cleanup
        run: |
          rm -rf temp_assets
          echo "=== åŒæ­¥å®Œæˆ ==="
          echo "âœ… æ‰€æœ‰ Tags å’Œ Releases å·²åŒæ­¥"
          echo "ğŸ“Š æŸ¥çœ‹ç»“æœ: https://github.com/$GITHUB_REPOSITORY/releases"
